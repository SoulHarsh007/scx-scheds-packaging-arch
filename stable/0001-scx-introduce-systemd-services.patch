From c2b1ef1bcaf037fe9b4ace711059e7d8c0973318 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 25 Jan 2024 16:52:39 +0100
Subject: [PATCH] scx: introduce systemd services

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 meson.build                      |  6 ++++++
 meson.options                    |  6 ++++++
 services/journald@sched-ext.conf |  9 +++++++++
 services/meson.build             | 16 ++++++++++++++++
 services/scx_central.service     | 13 +++++++++++++
 services/scx_flatcg.service      | 13 +++++++++++++
 services/scx_nest.service        | 13 +++++++++++++
 services/scx_pair.service        | 13 +++++++++++++
 services/scx_qmap.service        | 13 +++++++++++++
 services/scx_rustland.service    | 13 +++++++++++++
 services/scx_rusty.service       | 13 +++++++++++++
 services/scx_simple.service      | 13 +++++++++++++
 services/scx_userland.service    | 13 +++++++++++++
 13 files changed, 154 insertions(+)
 create mode 100644 services/journald@sched-ext.conf
 create mode 100644 services/meson.build
 create mode 100644 services/scx_central.service
 create mode 100644 services/scx_flatcg.service
 create mode 100644 services/scx_nest.service
 create mode 100644 services/scx_pair.service
 create mode 100644 services/scx_qmap.service
 create mode 100644 services/scx_rustland.service
 create mode 100644 services/scx_rusty.service
 create mode 100644 services/scx_simple.service
 create mode 100644 services/scx_userland.service

diff --git a/meson.build b/meson.build
index 1b105e2..5842311 100644
--- a/meson.build
+++ b/meson.build
@@ -158,3 +158,9 @@ if get_option('enable_rust')
   subdir('rust')
 endif
 subdir('scheds')
+
+systemd = dependency('systemd', required: get_option('systemd'))
+
+if systemd.found()
+  subdir('services')
+endif
diff --git a/meson.options b/meson.options
index a8752df..6cd9260 100644
--- a/meson.options
+++ b/meson.options
@@ -16,3 +16,9 @@ option('enable_rust', type: 'boolean', value: 'true',
        description: 'Enable rust sub-projects')
 option('kernel', type: 'string', value: 'vmlinuz',
        description: 'kernel image used to test schedulers')
+option(
+  'systemd',
+  type: 'feature',
+  value: 'auto',
+  description: 'sd-notify support via libsystemd and install systemd unit files'
+)
diff --git a/services/journald@sched-ext.conf b/services/journald@sched-ext.conf
new file mode 100644
index 0000000..7f26560
--- /dev/null
+++ b/services/journald@sched-ext.conf
@@ -0,0 +1,9 @@
+[Journal]
+# Sets the maximum journal size to 25M for each namespace.
+SystemMaxUse=25M
+# Sets the maximum log age to 7 days.
+MaxRetentionSec=7day
+# Sets the priority level for messages to be stored to info.
+MaxLevelStore=info
+# Sets the maximum number of log files that can be stored for each namespace.
+SystemMaxFiles=5
diff --git a/services/meson.build b/services/meson.build
new file mode 100644
index 0000000..1bccca8
--- /dev/null
+++ b/services/meson.build
@@ -0,0 +1,16 @@
+systemd_system_unit_dir = systemd.get_variable(pkgconfig : 'systemdsystemunitdir')
+
+  install_data(
+    [
+      'scx_central.service',  'scx_flatcg.service',  'scx_nest.service',  'scx_pair.service', 'scx_qmap.service', 'scx_rustland.service',  'scx_rusty.service',  'scx_simple.service',  'scx_userland.service',
+    ],
+    install_dir: systemd_system_unit_dir
+  )
+
+  install_data(
+    [
+      'journald@sched-ext.conf',
+    ],
+    install_dir: '/etc/systemd'
+  )
+
diff --git a/services/scx_central.service b/services/scx_central.service
new file mode 100644
index 0000000..eb15f0a
--- /dev/null
+++ b/services/scx_central.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_central
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_central
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_flatcg.service b/services/scx_flatcg.service
new file mode 100644
index 0000000..08eefc3
--- /dev/null
+++ b/services/scx_flatcg.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_flatcg
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_flatcg
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_nest.service b/services/scx_nest.service
new file mode 100644
index 0000000..49dfda6
--- /dev/null
+++ b/services/scx_nest.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_nest
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_nest
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_pair.service b/services/scx_pair.service
new file mode 100644
index 0000000..5d0e985
--- /dev/null
+++ b/services/scx_pair.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_pair
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_pair
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_qmap.service b/services/scx_qmap.service
new file mode 100644
index 0000000..e871564
--- /dev/null
+++ b/services/scx_qmap.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_qmap
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_qmap
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_rustland.service b/services/scx_rustland.service
new file mode 100644
index 0000000..e879109
--- /dev/null
+++ b/services/scx_rustland.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_rustland
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_rustland
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_rusty.service b/services/scx_rusty.service
new file mode 100644
index 0000000..d47007e
--- /dev/null
+++ b/services/scx_rusty.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_rusty
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_rusty
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_simple.service b/services/scx_simple.service
new file mode 100644
index 0000000..5f5c715
--- /dev/null
+++ b/services/scx_simple.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_simple
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_simple
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_userland.service b/services/scx_userland.service
new file mode 100644
index 0000000..8db25e4
--- /dev/null
+++ b/services/scx_userland.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=Start scx_userland
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+ExecStart=scx_userland
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
-- 
2.43.0.232.ge79552d197

